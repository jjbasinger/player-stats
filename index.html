<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Bay Bros Wiffle — Player Stats</title>

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css"/>

  <style>
    :root{ --accent:#004466; --accent-dark:#00334a; --muted:#f4f6f7; }
    body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:20px; color:#222;}
    h1{ margin:0 0 10px 0; font-size:1.5rem;}
    #controls{ display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    #tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab-btn{ padding:8px 12px; border-radius:8px; border:1px solid #ddd; background:white; cursor:pointer; font-size:0.95rem;}
    .tab-btn.active{ background:var(--accent); color:white; border-color:var(--accent-dark); box-shadow:0 2px 6px rgba(0,0,0,.06);}
    #sheet-select{ padding:8px; border-radius:6px; border:1px solid #ccc; display:none; }
    #reload{ padding:8px 10px; border-radius:6px; border:1px solid #ccc; background: #fff; cursor:pointer;}
    #table-wrap{ margin-top:8px; }
    table.dataTable thead { background: var(--accent); color: #fff; }
    @media (max-width:720px){
      #tabs{ display:none; }
      #sheet-select{ display:inline-block; }
    }
  </style>
</head>
<body>
  <h1>Bay Bros Wiffle — Player Stats</h1>

  <div id="controls">
    <div id="tabs"></div>
    <select id="sheet-select"></select>
    <button id="reload">Reload</button>
  </div>

  <div id="table-wrap">
    <table id="stats-table" class="display" style="width:100%; display:none;">
      <thead><tr id="stats-header"></tr></thead>
      <tbody id="stats-body"></tbody>
    </table>
    <div id="no-data" style="display:none; color:#b00; margin-top:8px;"></div>
  </div>

  <!-- libraries -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <script>
  (function(){
    ///////////////////////////
    // CONFIG — EDIT THESE
    ///////////////////////////
    const SPREADSHEET_ID = "2PACX-1vS9PBgLUF3MZqsXOQnbV_nptNSKLfST-rRMwf8J7Py0LSc9G5NY_zjkN8WPHkA1HRR-6A8rn4MRudNF"; // replace this
    const SHEETS_INFO = [
      { name: "Season 7 Batting Stats", gid: "1205657621" },
      { name: "Season 7 Pitching Stats", gid: "1096602333" },
      { name: "Career Batting Stats", gid: "782230934" },
      { name: "Career Pitching Stats", gid: "509746022" },
      { name: "Season 6 Batting Stats", gid: "1316608386" },
      { name: "Season 6 Pitching Stats", gid: "244783453" }
    ];
    ///////////////////////////

    const CACHE_TTL = 1000 * 60 * 5; // 5 minutes
    const TPL_CSV_URL = gid => `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/pub?output=csv&gid=${gid}`;

    const tabsWrap = document.getElementById('tabs');
    const select = document.getElementById('sheet-select');
    const reloadBtn = document.getElementById('reload');
    const headerRowEl = document.getElementById('stats-header');
    const bodyEl = document.getElementById('stats-body');
    const tableEl = $('#stats-table');
    const noDataEl = document.getElementById('no-data');

    let dataTable = null;
    let currentGid = null;

    function detectNumeric(val){
      if (val == null) return null;
      let s = String(val).trim();
      if (s === "") return null;
      const cleaned = s.replace(/,/g, '').replace(/%/g, '');
      if (/^-?\d*\.?\d+$/.test(cleaned)) {
        const n = parseFloat(cleaned);
        return isFinite(n) ? n : null;
      }
      return null;
    }

    function getCachedRows(gid){
      try {
        const raw = sessionStorage.getItem('sheet_cache_' + gid);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (Date.now() - parsed.ts > CACHE_TTL) {
          sessionStorage.removeItem('sheet_cache_' + gid);
          return null;
        }
        return parsed.rows;
      } catch(e){ return null; }
    }
    function setCachedRows(gid, rows){
      try {
        sessionStorage.setItem('sheet_cache_' + gid, JSON.stringify({ts: Date.now(), rows}));
      } catch(e){}
    }
    function clearCache(gid){
      try{ sessionStorage.removeItem('sheet_cache_' + gid); } catch(e){}
    }

    function buildTable(rows){
      noDataEl.style.display = 'none';
      if (!rows || rows.length === 0) {
        tableEl.hide();
        headerRowEl.innerHTML = '';
        bodyEl.innerHTML = '';
        noDataEl.textContent = 'No data found in this sheet.';
        noDataEl.style.display = 'block';
        return;
      }
      const header = rows[0].map(h => h == null ? '' : String(h));
      const bodyRows = rows.slice(1);

      headerRowEl.innerHTML = '';
      bodyEl.innerHTML = '';

      header.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col;
        headerRowEl.appendChild(th);
      });

      bodyRows.forEach(row => {
        const tr = document.createElement('tr');
        header.forEach((_, i) => {
          const rawVal = row[i] == null ? '' : row[i];
          const numVal = detectNumeric(rawVal);
          const td = document.createElement('td');
          if (numVal !== null) td.setAttribute('data-order', String(numVal));
          td.textContent = rawVal;
          tr.appendChild(td);
        });
        bodyEl.appendChild(tr);
      });

      if (dataTable) {
        try { dataTable.destroy(); } catch(e){}
      }
      tableEl.show();
      dataTable = tableEl.DataTable({
        paging: true,
        searching: true,
        info: true,
        order: [[1, 'desc']],
        lengthMenu: [10, 25, 50, 100],
        autoWidth: false,
        responsive: true
      });
    }

    function loadCsvForGid(gid, {force=false} = {}){
      const url = TPL_CSV_URL(gid);
      currentGid = gid;
      reloadBtn.disabled = true;
      reloadBtn.textContent = 'Loading...';

      if (!force) {
        const cached = getCachedRows(gid);
        if (cached) {
          buildTable(cached);
          reloadBtn.disabled = false;
          reloadBtn.textContent = 'Reload';
          return;
        }
      }

      Papa.parse(url, {
        download: true,
        skipEmptyLines: true,
        complete: function(results) {
          setCachedRows(gid, results.data);
          buildTable(results.data);
          reloadBtn.disabled = false;
          reloadBtn.textContent = 'Reload';
        },
        error: function(err) {
          noDataEl.style.display = 'block';
          noDataEl.textContent = 'Error fetching CSV: ' + err.message;
          reloadBtn.disabled = false;
          reloadBtn.textContent = 'Reload';
        }
      });
    }

    function renderSheetSelector(sheets){
      tabsWrap.innerHTML = '';
      select.innerHTML = '';

      sheets.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.gid;
        opt.textContent = s.name;
        select.appendChild(opt);
      });

      sheets.forEach((s, idx) => {
        const btn = document.createElement('button');
        btn.className = 'tab-btn';
        btn.type = 'button';
        btn.textContent = s.name;
        btn.dataset.gid = s.gid;
        btn.addEventListener('click', function(){
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          select.value = s.gid;
          loadCsvForGid(s.gid);
        });
        tabsWrap.appendChild(btn);
      });

      if (sheets.length > 0) {
        const first = sheets[0];
        const firstBtn = tabsWrap.querySelector('.tab-btn');
        if (firstBtn) firstBtn.classList.add('active');
        select.value = first.gid;
        select.addEventListener('change', function(){
          document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.toggle('active', b.dataset.gid === select.value);
          });
          loadCsvForGid(select.value);
        });
        loadCsvForGid(first.gid);
      }
    }

    function init(){
      if (!SPREADSHEET_ID || SPREADSHEET_ID === "YOUR_SPREADSHEET_ID") {
        noDataEl.style.display = 'block';
        noDataEl.textContent = 'Please configure SPREADSHEET_ID and SHEETS_INFO.';
        return;
      }
      if (!Array.isArray(SHEETS_INFO) || SHEETS_INFO.length === 0) {
        noDataEl.style.display = 'block';
        noDataEl.textContent = 'SHEETS_INFO is empty.';
        return;
      }
      renderSheetSelector(SHEETS_INFO);
      reloadBtn.addEventListener('click', function(){
        if (!currentGid) return;
        clearCache(currentGid);
        loadCsvForGid(currentGid, {force:true});
      });
    }

    init();
  })();
  </script>
</body>
</html>
